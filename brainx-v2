#!/bin/bash
# BrainX v2 - Unified Memory Intelligence System
set -euo pipefail

# === COLORS ===
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly NC='\033[0m'
readonly BOLD='\033[1m'

# === VERSION ===
readonly BRAINX_VERSION="2.1.0"
readonly BRAINX_HOME="${BRAINX_HOME:-/home/clawd/.openclaw/workspace/skills/brainx-v2}"

# === LOAD CONFIG ===
load_config() {
    [[ -f "$BRAINX_HOME/config/brainx.conf" ]] && source "$BRAINX_HOME/config/brainx.conf"
}

# === LOAD LIBRARIES ===
load_libraries() {
    local lib_dir="$BRAINX_HOME/lib"
    source "$lib_dir/core.sh"
    source "$lib_dir/counter.sh"
    source "$lib_dir/storage.sh"
    source "$lib_dir/rag.sh"
    source "$lib_dir/hooks.sh"
    source "$lib_dir/registry.sh"
    source "$lib_dir/scoring.sh"
    source "$lib_dir/filter.sh"
    source "$lib_dir/compressor.sh"
    source "$lib_dir/batcher.sh"
    source "$lib_dir/estimator.sh"
    source "$lib_dir/caching.sh"
    source "$lib_dir/context.sh"
    source "$lib_dir/inject.sh"
    source "$lib_dir/second-brain.sh"
    source "$lib_dir/metrics.sh"
    source "$lib_dir/scheduler.sh"
    source "$lib_dir/webhooks.sh"
    source "$lib_dir/audit.sh"
    source "$lib_dir/truncator.sh"
    source "$lib_dir/relevance.sh"
    source "$lib_dir/optimizer.sh"
    # New optimization modules
    source "$lib_dir/local_compressor.sh"
    source "$lib_dir/summarizer.sh"
    source "$lib_dir/dedup.sh"
}
# === PRINT HELP ===
print_help() {
    cat <<EOF
${BOLD}BrainX v${BRAINX_VERSION} - Unified Memory Intelligence System${NC}

${BOLD}USAGE:${NC}
    brainx-v2 <command> [options]

${BOLD}MEMORY MANAGEMENT:${NC}
    add <type> <content> [context] [tier]     Add memory to storage
    get <id>                                   Get memory by ID
    search <query>                             Search all memory
    recall [context] [limit]                   Progressive recall

${BOLD}STORAGE TIERS:${NC}
    hot|warm|cold <subcommand>                 Manage tier (list, count, cleanup)

${BOLD}AGENT HOOKS:${NC}
    hook start <agent> <context>               Start session hook
    hook decision <action> <reason> [imp]     Record decision
    hook action <desc> <result> [tags]        Record action
    hook learning <pattern> <lesson> [src]    Record learning
    hook gotcha <issue> <workaround> [sev]    Record gotcha/workaround
    hook end <summary>                          End session hook

${BOLD}RAG SEARCH:${NC}
    rag <query>                                Semantic RAG search
    rag index <path>                           Index content

${BOLD}SECOND-BRAIN:${NC}
    sb add <category> <content>                Add to second-brain
    sb search <query>                          Search second-brain
    sb list                                    List categories

${BOLD}OPTIMIZATION PIPELINE:${NC}
    inject <query>                             Full injection pipeline
    filter <query>                             Filter by relevance
    compress <text>                            Compress text
    local-compress <text>                      Compress with local model
    local-health                               Check local model status
    dedup <items.json>                         Semantic deduplication
    summarize <messages.json>                  Progressive summarization
    count <text>                               Count tokens
    truncate <json>                           Truncate history
    relevance <query> <context>                Calculate relevance score
    optimize <query> [system] [history]       Full optimization pipeline
    diagnose <context>                         Diagnose context size

${BOLD}TOKEN & COST:${NC}
    cost <text> [model]                       Estimate cost
    budget                                     Show budget status

${BOLD}METRICS & TRACKING:${NC}
    metrics start <agent> <context>            Start tracking session
    metrics tokens <session> <in> <out> <cost>  Track token usage
    metrics end <session> <summary>            End tracking session
    metrics report                             Show metrics report
    metrics export [csv_file]                   Export to CSV

${BOLD}SCHEDULED TASKS:${NC}
    schedule add <name> <cron> <agent> <cmd>   Add scheduled task
    schedule list                             List scheduled tasks
    schedule run <id>                         Run task immediately
    schedule remove <id>                       Remove task
    schedule toggle <id>                       Enable/disable task
    schedule sync                             Generate crontab entries

${BOLD}WEBHOOKS:${NC}
    webhook register <name> <url> <event>      Register webhook
    webhook list                               List webhooks
    webhook trigger <id> <payload>              Manually trigger webhook
    webhook remove <id>                        Remove webhook
    webhook test <id>                          Test webhook
    webhook logs                               View webhook logs

${BOLD}AUDIT LOG:${NC}
    audit query [agent] [type] [limit]         Query audit logs
    audit activity <agent> [days]              Agent activity report
    audit security                             Security audit report
    audit stats                                Audit statistics
    audit cleanup [days]                       Cleanup old entries

${BOLD}UTILITIES:${NC}
    agents                                     List registered agents
    stats                                      Show statistics
    health                                     System health check
    help                                       Show this help

${BOLD}EXAMPLES:${NC}
    brainx-v2 add decision "Using cache" "Performance context" warm
    brainx-v2 search "API authentication"
    brainx-v2 rag "how to configure nginx"
    brainx-v2 hook start claude "Working on project X"
    brainx-v2 sb add commands "grep -r pattern" "Search recursively"

EOF
}

# === MAIN ===
main() {
    load_config
    load_libraries
    
    if [[ $# -eq 0 ]]; then
        print_help
        exit 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        # Memory Management
        add)
            brainx_mem_add "$@"
            ;;
        get)
            brainx_mem_get "$@"
            ;;
        search)
            brainx_mem_search "$@"
            ;;
        recall)
            brainx_recall "$@"
            ;;
            
        # Storage Tiers
        hot|warm|cold)
            brainx_tier_manage "$command" "$@"
            ;;
            
        # Agent Hooks
        hook)
            brainx_hook_manage "$@"
            ;;
            
        # RAG
        rag)
            brainx_rag_manage "$@"
            ;;
            
        # Second-Brain
        sb)
            brainx_sb_manage "$@"
            ;;
            
        # Optimization Pipeline
        inject)
            brainx_inject "$@"
            ;;
        filter)
            brainx_filter "$@"
            ;;
        compress)
            brainx_compress "$@"
            ;;
        local-compress)
            brainx_local_compress "$@"
            ;;
        local-health)
            brainx_local_health
            ;;
        dedup)
            brainx_dedup "$@"
            ;;
        summarize)
            brainx_summarize "$@"
            ;;
        count)
            brainx_count "$@"
            ;;
        truncate)
            brainx_truncate "$@"
            ;;
        relevance)
            brainx_relevance "$@"
            ;;
        optimize)
            brainx_optimize "$@"
            ;;
        diagnose)
            brainx_diagnose "$@"
            ;;
        cost)
            brainx_cost "$@"
            ;;
        budget)
            brainx_budget "$@"
            ;;
            
        # Metrics
        metrics)
            brainx_metrics_manage "$@"
            ;;
            
        # Scheduler
        schedule)
            brainx_schedule_manage "$@"
            ;;
            
        # Webhooks
        webhook)
            brainx_webhook_manage "$@"
            ;;
            
        # Audit
        audit)
            brainx_audit_manage "$@"
            ;;
            
        # Utilities
        agents)
            brainx_agents_list
            ;;
        stats)
            brainx_stats
            ;;
        health)
            brainx_health_check
            ;;
        help|--help|-h)
            print_help
            ;;
            
        *)
            brainx_error "Unknown command: $command"
            print_help
            exit 1
            ;;
    esac
}

# === DEFAULT STUB FUNCTIONS (overridden by libraries) ===
brainx_mem_add() { brainx_error "Command not implemented: add"; }
brainx_mem_get() { brainx_error "Command not implemented: get"; }
brainx_mem_search() { brainx_error "Command not implemented: search"; }
brainx_recall() { brainx_error "Command not implemented: recall"; }
brainx_tier_manage() { brainx_error "Command not implemented: tier"; }
brainx_hook_manage() { brainx_error "Command not implemented: hook"; }
brainx_rag_manage() { brainx_error "Command not implemented: rag"; }
brainx_sb_manage() { brainx_error "Command not implemented: second-brain"; }
brainx_inject() { brainx_error "Command not implemented: inject"; }
brainx_filter() { brainx_error "Command not implemented: filter"; }
brainx_compress() { brainx_error "Command not implemented: compress"; }
brainx_batch() { brainx_error "Command not implemented: batch"; }
brainx_score() { brainx_error "Command not implemented: score"; }

# === METRICS HELP ===
brainx_metrics_help() {
    cat <<EOF
${BOLD}Metrics Commands${NC}
====================
Usage: brainx-v2 metrics <command> [options]

Commands:
    start <agent> <context>    Start tracking session
    tokens <id> <in> <out> <cost>  Track token usage
    end <id> <summary>         End tracking session
    report                     Show metrics report
    export [file.csv]          Export to CSV
    cleanup [keep]             Cleanup old entries
EOF
}

# === SCHEDULER HELP ===
brainx_schedule_help() {
    cat <<EOF
${BOLD}Scheduler Commands${NC}
=====================
Usage: brainx-v2 schedule <command> [options]

Commands:
    add <name> <cron> <agent> <cmd>   Add scheduled task
    list                              List scheduled tasks
    run <id>                          Run task immediately
    remove <id>                       Remove task
    toggle <id>                       Enable/disable task
    sync                              Generate crontab entries
EOF
}

# === WEBHOOK HELP ===
brainx_webhook_help() {
    cat <<EOF
${BOLD}Webhook Commands${NC}
====================
Usage: brainx-v2 webhook <command> [options]

Commands:
    register <name> <url> <event>    Register webhook
    list                             List webhooks
    trigger <id> <payload>           Manually trigger
    remove <id>                       Remove webhook
    test <id>                         Test webhook
    logs                              View logs
EOF
}

# === AUDIT HELP ===
brainx_audit_help() {
    cat <<EOF
${BOLD}Audit Commands${NC}
==================
Usage: brainx-v2 audit <command> [options]

Commands:
    query [agent] [type] [limit]     Query logs
    activity <agent> [days]         Activity report
    security                         Security report
    stats                            Statistics
    cleanup [days]                   Cleanup old entries
EOF
}

# === METRICS MANAGER (dispatcher) ===
brainx_metrics_manage() {
    [[ $# -eq 0 ]] && { brainx_metrics_help; return; }
    local cmd="$1"; shift
    case "$cmd" in
        start) metrics_init; metrics_session_start "$@" ;;
        tokens) metrics_track_tokens "$@" ;;
        end) metrics_session_end "$@" ;;
        report) metrics_report ;;
        export) metrics_export_csv "${1:-metrics.csv}" ;;
        cleanup) metrics_cleanup "${1:-100}" ;;
        *) brainx_metrics_help ;;
    esac
}

# === SCHEDULER MANAGER (dispatcher) ===
brainx_schedule_manage() {
    [[ $# -eq 0 ]] && { brainx_schedule_help; return; }
    local cmd="$1"; shift
    case "$cmd" in
        add) scheduler_add "$@" ;;
        list) scheduler_list ;;
        run) scheduler_run "$@" ;;
        remove) scheduler_remove "$@" ;;
        toggle) scheduler_toggle "$@" ;;
        sync) scheduler_sync_cron ;;
        *) brainx_schedule_help ;;
    esac
}

# === WEBHOOK MANAGER (dispatcher) ===
brainx_webhook_manage() {
    [[ $# -eq 0 ]] && { brainx_webhook_help; return; }
    local cmd="$1"; shift
    case "$cmd" in
        register) webhooks_init; webhook_register "$@" ;;
        list) webhook_list ;;
        trigger) webhook_trigger "$@" ;;
        remove) webhook_remove "$@" ;;
        test) webhook_test "$@" ;;
        logs) webhook_logs ;;
        *) brainx_webhook_help ;;
    esac
}

# === AUDIT MANAGER (dispatcher) ===
brainx_audit_manage() {
    [[ $# -eq 0 ]] && { brainx_audit_help; return; }
    local cmd="$1"; shift
    case "$cmd" in
        query) audit_query_logs "$@" ;;
        activity) audit_agent_activity "$@" ;;
        security) audit_security_report ;;
        stats) audit_stats ;;
        cleanup) audit_cleanup "${1:-90}" ;;
        *) brainx_audit_help ;;
    esac
}

brainx_agents_list() { brainx_error "Command not implemented: agents"; }
brainx_stats() { brainx_error "Command not implemented: stats"; }
brainx_health_check() { brainx_error "Command not implemented: health"; }

# === OPTIMIZATION COMMANDS ===
brainx_count() {
    local text="${*:-}"
    if [[ -z "$text" ]]; then
        brainx_error "Usage: brainx-v2 count <text>"
        return 1
    fi
    count_tokens_verbose "$text"
}

brainx_truncate() {
    local json="${1:-}"
    if [[ -z "$json" ]]; then
        brainx_error "Usage: brainx-v2 truncate <json>"
        return 1
    fi
    smart_truncate "$json"
}

brainx_relevance() {
    local query="${1:-}"
    local context="${2:-}"
    if [[ -z "$query" ]]; then
        brainx_error "Usage: brainx-v2 relevance <query> <context>"
        return 1
    fi
    local score=$(calculate_relevance "$query" "$context")
    local verdict=$(relevance_verdict "$score")
    echo "Score: $score (threshold: $RELEVANCE_THRESHOLD)"
    echo "Verdict: $verdict"
}

brainx_optimize() {
    local query="${1:-}"
    if [[ -z "$query" ]]; then
        brainx_error "Usage: brainx-v2 optimize <query> [system_prompt] [history_json]"
        return 1
    fi
    local system_prompt="${2:-}"
    local history="${3:-}"
    optimize_context "$query" "$system_prompt" "$history" ""
}

brainx_diagnose() {
    local context="${1:-}"
    if [[ -z "$context" ]]; then
        brainx_error "Usage: brainx-v2 diagnose <context>"
        return 1
    fi
    diagnose_context "$context"
}

brainx_cost() {
    local text="${1:-}"
    local model="${2:-MiniMax-M2.1}"
    if [[ -z "$text" ]]; then
        brainx_error "Usage: brainx-v2 cost <text> [model]"
        return 1
    fi
    cost_optimize "$text" "$model"
}

brainx_budget() {
    cat <<EOF
${BOLD}Token Budget Configuration${NC}
================================
Budget: $(format_tokens $TOKEN_BUDGET)
Warning Threshold: $(format_tokens $WARNING_THRESHOLD)
COST_INPUT: \$$COST_INPUT per 1M
COST_OUTPUT: \$$COST_OUTPUT per 1M
COST_CACHE_READ: \$$COST_CACHE_READ per 1M
COST_CACHE_WRITE: \$$COST_CACHE_WRITE per 1M
EOF
}

main "$@"
